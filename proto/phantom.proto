syntax = "proto3";

package phantom.v1;

option java_package = "com.phantomnet.core.protocol";
option java_multiple_files = true;

/**
 * All messages in Phantom Net, whether Onion or Mixnet, share a common packet structure
 * to prevent packet-size fingerprinting.
 */
message PhantomPacket {
    // Shared fixed-size padding (MTU alignment)
    bytes padding = 1;
    
    oneof content {
        OnionLayer onion = 2;
        MixnetLayer mixnet = 3;
        DCNetRound dc_net = 4;
    }
}

/**
 * Basic multi-hop onion routing layer.
 */
message OnionLayer {
    bytes next_hop_pubkey = 1;
    bytes routing_token = 2;
    bytes encrypted_payload = 3; // Recursive OnionLayer or ApplicationPayload
}

/**
 * Nym-inspired mixnet layer with batching and epochs.
 */
message MixnetLayer {
    uint32 epoch_id = 1;
    bytes batch_signature = 2; // For verifiable shuffle
    bytes encrypted_payload = 3; 
}

/**
 * Dining Cryptographers (DC-Net) round contribution.
 */
message DCNetRound {
    uint64 round_id = 1;
    bytes xor_contribution = 2;
}

/**
 * The end-to-end encrypted payload containing the actual application data.
 */
message ApplicationPayload {
    bytes relationship_id = 1;
    bytes signal_ciphertext = 2; // X3DH + Double Ratchet + Kyber Hybrid
    uint64 timestamp = 3;
    MessageType type = 4;
}

enum MessageType {
    TEXT = 0;
    MEDIA = 1;
    GROUP_SYNC_MLS = 2;
    PSI_REQUEST = 3;
    HEARTBEAT_COVER = 4;
    CALL_SIGNAL = 5;
}

/**
 * Calling control payload serialized inside ApplicationPayload.signal_ciphertext
 * when MessageType is CALL_SIGNAL.
 */
message CallControl {
    bytes session_id = 1; // Bound to relationship_id domain
    uint64 sequence = 2; // Monotonic sequence for replay protection
    uint64 timestamp = 3;
    CallSignalType signal_type = 4;
    CallMode mode = 5;
    CallMediaKind media_kind = 6;
    bytes auth_tag = 7; // MAC over critical fields from E2EE-derived call secret

    oneof detail {
        CallOffer offer = 20;
        CallAnswer answer = 21;
        IceCandidate candidate = 22;
        CallAccept accept = 23;
        CallDecline decline = 24;
        CallRing ring = 25;
        CallRekey rekey = 26;
        CallHangup hangup = 27;
        CallModeSwitchRequest mode_switch_request = 28;
        CallModeSwitchAck mode_switch_ack = 29;
    }
}

enum CallSignalType {
    CALL_OFFER = 0;
    CALL_ANSWER = 1;
    CALL_CANDIDATE = 2;
    CALL_ACCEPT = 3;
    CALL_DECLINE = 4;
    CALL_RING = 5;
    CALL_REKEY = 6;
    CALL_HANGUP = 7;
    CALL_MODE_SWITCH_REQUEST = 8;
    CALL_MODE_SWITCH_ACK = 9;
}

enum CallMode {
    FAST = 0;
    PRIVATE = 1;
    PARANOID = 2;
}

enum CallMediaKind {
    AUDIO = 0;
    VIDEO = 1;
    AUDIO_VIDEO = 2;
}

enum CandidateClass {
    HOST = 0;
    SRFLX = 1;
    RELAY = 2;
    MIXNET = 3;
}

enum DeclineReason {
    USER_DECLINED = 0;
    BUSY = 1;
    POLICY_BLOCKED = 2;
    TIMEOUT = 3;
}

enum HangupReason {
    USER_ENDED = 0;
    REMOTE_ENDED = 1;
    NETWORK_LOSS = 2;
    FAILED_MEDIA = 3;
}

message CallOffer {
    bytes sdp_offer = 1;
    repeated CandidateClass allowed_candidates = 2;
    bool anti_downgrade_required = 3;
    bool supports_mode_switch = 4;
    bool supports_video_upgrade = 5;
    bytes key_commitment = 6;
}

message CallAnswer {
    bytes sdp_answer = 1;
    repeated CandidateClass selected_candidates = 2;
    bool accepted = 3;
}

message IceCandidate {
    bytes candidate = 1;
    bytes sdp_mid = 2;
    uint32 sdp_mline_index = 3;
    CandidateClass candidate_class = 4;
    bool end_of_candidates = 5;
}

message CallAccept {
    CallMediaKind accepted_media_kind = 1;
}

message CallDecline {
    DeclineReason reason = 1;
}

message CallRing {
    bool remote_ringing = 1;
}

message CallRekey {
    uint64 rekey_epoch = 1;
    bytes key_commitment = 2;
}

message CallHangup {
    HangupReason reason = 1;
    uint32 duration_sec = 2;
}

message CallModeSwitchRequest {
    CallMode target_mode = 1;
    bool user_confirmed = 2;
}

message CallModeSwitchAck {
    CallMode target_mode = 1;
    bool accepted = 2;
    bytes rejection_code = 3;
}
