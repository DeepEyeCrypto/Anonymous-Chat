# PHANTOM NET v2.0: WORLD

> **Status**: ACTIVE  
> **Version**: 2.0.0  
> **Date**: 2026-02-20  
> **Focus**: CI/CD updates, dependency management, release strategy, and deployment for Phase 1 (SOLID GROUND).

---

## 1. REPOSITORY & BRANCH STRATEGY

### Structure: Mono-repo (unchanged)

```
Anonymous-Chat/
‚îú‚îÄ‚îÄ .github/workflows/     # CI pipelines
‚îú‚îÄ‚îÄ android/               # Kotlin/Compose app (multi-module Gradle)
‚îú‚îÄ‚îÄ rust/                  # Rust workspace (all native crates)
‚îú‚îÄ‚îÄ scripts/               # Build automation
‚îú‚îÄ‚îÄ docs/                  # FLOW documents
‚îî‚îÄ‚îÄ CHANGELOG.md
```

### Branching Model: Trunk-based

| Branch | Purpose | Merges to |
|--------|---------|-----------|
| `main` | Stable, released code. Every commit is deployable. | ‚Äî |
| `dev` | **NEW** ‚Äî Integration branch for v2.0 work | `main` via PR |
| `feature/*` | Short-lived feature branches | `dev` via PR |
| `fix/*` | Hotfixes for released versions | `main` directly |

### Tagging & Versioning

- **Semantic versioning**: `v{major}.{minor}.{patch}`
- **Pre-release tags**: `v2.0.0-alpha.1`, `v2.0.0-alpha.2`, ...
- **Release tags**: `v2.0.0`
- **Tag triggers release CI** (existing behavior, unchanged)

### Version sync points

| File | Field | Must match tag |
|------|-------|---------------|
| `android/app/build.gradle.kts` | `versionName` | `2.0.0-alpha.1` |
| `android/app/build.gradle.kts` | `versionCode` | Monotonically increasing (8, 9, ...) |
| `CHANGELOG.md` | Top entry header | `[2.0.0-alpha.1]` |

---

## 2. ENVIRONMENT MATRIX

| Environment | Purpose | Config | Data |
|-------------|---------|--------|------|
| **Local dev** | Developer machine. Android Studio + Emulator. | `debug` build type, mock data seed. | SQLCipher with test key |
| **CI (GitHub Actions)** | Automated build + test on push/PR/tag. | `release` build type, no secrets needed (debug keystore). | No persistent data |
| **Staging** | N/A for Phase 1 (no server). | ‚Äî | ‚Äî |
| **Production** | User's device. Side-loaded APK. | `release` build, EncryptedPrefs for real key material. | SQLCipher with user-generated key |

### Secrets & Config

| Secret | Where stored | Used by |
|--------|-------------|---------|
| Debug keystore | Auto-generated by Android SDK | CI release signing |
| Release keystore | **Future**: GitHub Encrypted Secrets | Play Store (not Phase 1) |
| EncryptedPrefs master key | Android Keystore (device) | SQLCipher passphrase derivation |
| Persona private keys | EncryptedSharedPreferences | Crypto operations |

**No server secrets in Phase 1.** No API keys. No cloud credentials. Everything is local.

---

## 3. CI/CD PIPELINES

### 3.1 Rust CI (`rust-ci.yml`) ‚Äî On push/PR to `main` and `dev`

```yaml
Trigger: push to main/dev, PR to main/dev

Steps:
  1. Checkout
  2. Install system deps (libdbus-1-dev, pkg-config, protobuf-compiler)
  3. Setup Rust (stable)
  4. Cache cargo registry + build artifacts
  5. cargo check --workspace
  6. cargo test --workspace --lib
  7. cargo clippy --workspace -- -D warnings     # NEW: lint enforcement
```

**Changes needed**:

- Add `dev` branch to triggers
- Add `cargo clippy` step for lint enforcement
- Add `cargo audit` step for dependency vulnerability scanning

### 3.2 Android CI (`android.yml`) ‚Äî On push/PR to `dev` (build check)

**NEW pipeline for `dev` branch PRs** ‚Äî fast feedback without full release:

```yaml
Trigger: push to dev, PR to dev

Steps:
  1. Checkout
  2. Setup JDK 21
  3. Setup Android SDK
  4. Setup Gradle 8.10.2 (with cache)
  5. Build Android App (assembleDebug only ‚Äî no native libs needed)
  6. Run Android unit tests (./gradlew test)
```

**Purpose**: Catch Kotlin compilation errors and test failures before merging to `dev`. Does NOT build Rust or produce APKs.

### 3.3 Android Release (`android-release.yml`) ‚Äî On tag push `v*`

```yaml
Trigger: push tags v*

Steps:
  1. Checkout
  2. Setup JDK 21
  3. Setup Android SDK + NDK 25.1.8937393
  4. Setup Gradle 8.10.2 (with cache)
  5. Setup Rust (stable) with Android targets
  6. Install cargo-ndk
  7. Build Native Libraries (./scripts/build_android_core.sh)
  8. Build Android App (assembleRelease || assembleDebug)
  9. Run unit tests (./gradlew test)               # NEW
  10. Upload APK artifact
  11. Create GitHub Release (with auto-generated notes)
```

**Changes from current `android.yml`**:

- Rename to `android-release.yml` for clarity
- Add unit test step before upload
- Keep existing fallback (`assembleRelease || assembleDebug`)

### 3.4 New dependencies for v2.0 Phase 1

The following must be added to `build.gradle.kts` files:

**`core:database/build.gradle.kts`** (new module):

```
net.zetetic:android-database-sqlcipher:4.5.6
androidx.room:room-runtime:2.6.1
androidx.room:room-ktx:2.6.1
androidx.room:room-compiler:2.6.1 (kapt/ksp)
```

**`core:identity/build.gradle.kts`** (new module):

```
androidx.security:security-crypto:1.1.0-alpha06
```

**`feature:onboarding/build.gradle.kts`** (new module):

```
com.airbnb.android:lottie-compose:6.3.0  (optional, for animations)
```

**`settings.gradle.kts`** ‚Äî must include new modules:

```kotlin
include(":app")
include(":core:crypto")
include(":core:network")
include(":core:database")    // NEW
include(":core:identity")    // NEW
include(":feature:onboarding") // NEW
include(":feature:settings")   // NEW
```

---

## 4. DEPLOYMENT ARCHITECTURE

### Phase 1: Device-only (no backend)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User Device  ‚îÇ
‚îÇ              ‚îÇ
‚îÇ  APK         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Kotlin  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Rust .so‚îÇ
‚îÇ              ‚îÇ
‚îÇ  SQLCipher DB‚îÇ
‚îÇ  EncryptedSP ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

No servers. No cloud. No Firebase. No analytics.

### Distribution channels

| Channel | Status | Notes |
|---------|--------|-------|
| **GitHub Releases** | ‚úÖ Active | Auto-created on tag push. APK downloadable. |
| **Direct sideload** | ‚úÖ Active | Share APK file directly. Signed with debug keystore. |
| **F-Droid** | üîú Phase 2 | Requires reproducible builds + metadata YAML. |
| **Play Store** | üîú Phase 3 | Requires release keystore + Play Console account. |

### APK signing strategy

| Build type | Keystore | Purpose |
|-----------|----------|---------|
| `debug` | Auto-generated debug keystore | Local dev, emulator |
| `release` (current) | Debug keystore (`signingConfig = debug`) | CI sideload APKs |
| `release` (future) | Dedicated release keystore in GitHub Secrets | Play Store / F-Droid |

**Phase 1 keeps debug keystore for release.** This is intentional ‚Äî sideload-only distribution doesn't need Play Store signing. We'll upgrade when targeting stores.

---

## 5. MONITORING, LOGGING, AND INCIDENT RESPONSE

### Phase 1: Minimal (no telemetry, no crash reporting)

**Deliberate choice**: Phantom Net is a privacy app. No Crashlytics, no Firebase Analytics, no Sentry.

| Mechanism | Implementation |
|-----------|---------------|
| **Logcat** | `Timber` (Android) + `android_logger` (Rust) for local debugging |
| **CI build logs** | GitHub Actions logs (auto-retained 90 days) |
| **User bug reports** | Manual ‚Äî user shares Logcat output via GitHub Issues |
| **Crash detection** | `Thread.setDefaultUncaughtExceptionHandler` ‚Üí log to file ‚Üí show "Report" dialog on next launch |

### Future (Phase 3+): Optional opt-in telemetry

- User explicitly enables crash reporting in Settings
- Crash logs are encrypted with our public key before submission
- No PII, no usage analytics, ever

---

## 6. RELEASE PROCESS

### 6.1 Release checklist (for each version)

```
‚ñ° All feature branches merged to dev
‚ñ° Dev branch passes Rust CI (check + test + clippy)
‚ñ° Dev branch passes Android CI (assembleDebug + test)
‚ñ° CHANGELOG.md updated with new version entry
‚ñ° Version bumped in build.gradle.kts (versionName + versionCode)
‚ñ° PR from dev ‚Üí main created with summary
‚ñ° PR reviewed and merged
‚ñ° Tag created on main: git tag -a v{version} -m "{summary}"
‚ñ° Tag pushed: git push origin v{version}
‚ñ° GitHub Actions builds APK and creates Release
‚ñ° Download APK from Release, install on test device, smoke test
‚ñ° Release published (draft ‚Üí full release)
```

### 6.2 Smoke test (manual, per release)

```
‚ñ° Fresh install on clean emulator/device
‚ñ° Onboarding completes
‚ñ° Identity generated and fingerprint displayed
‚ñ° All 4 tabs navigate correctly
‚ñ° Settings shows identity and core status
‚ñ° WIPE IDENTITY works (app resets to onboarding)
‚ñ° Kill app + reopen ‚Üí state persists
‚ñ° Rotate device ‚Üí no crash
```

### 6.3 Rollback strategy

| Scenario | Action |
|----------|--------|
| Critical crash in released APK | Push hotfix to `main`, tag new patch version, release immediately |
| Data migration failure | SQLCipher DB version is 1; migration failure = fallback to destructive migration (acceptable in alpha) |
| Native lib crash | PhantomCore/SignalBridge `*Safe()` wrappers degrade gracefully; no rollback needed |

### 6.4 Version cadence

| Phase | Cadence | Tag format |
|-------|---------|-----------|
| Phase 1 (alpha) | Every 3-5 features | `v2.0.0-alpha.N` |
| Phase 2 (beta) | Every 1-2 features | `v2.0.0-beta.N` |
| Phase 3 (rc) | Per feature | `v2.0.0-rc.N` |
| Stable | When Phase 1-3 complete | `v2.0.0` |

---

## 7. IMMEDIATE ACTIONS (TO START PHASE 1 IMPLEMENTATION)

Priority-ordered tasks to begin building:

| # | Task | Type | Estimated Effort |
|---|------|------|-----------------|
| 1 | Create `dev` branch from current `main` | Git | 1 min |
| 2 | Update `rust-ci.yml`: add `dev` trigger + clippy + audit | CI | 10 min |
| 3 | Create `android-ci.yml`: dev/PR build check (no native) | CI | 15 min |
| 4 | Scaffold `core:database` module with Room + SQLCipher | Code | 30 min |
| 5 | Scaffold `core:identity` module with EncryptedPrefs | Code | 20 min |
| 6 | Update `settings.gradle.kts` with new modules | Config | 5 min |
| 7 | Implement domain models (Persona, Conversation, Message) | Code | 15 min |
| 8 | Implement DAOs + Repository impls | Code | 45 min |
| 9 | Build Onboarding screens (3 screens + splash) | UI | 60 min |
| 10 | Build Settings screen | UI | 30 min |
| 11 | Refactor MainActivity to tab navigation + NavHost | UI | 45 min |
| 12 | Build empty states for Discovery + Vault tabs | UI | 20 min |
| 13 | Wire ViewModels to repositories | Wiring | 30 min |
| 14 | Tag `v2.0.0-alpha.1` and release | Release | 5 min |

**Total estimated: ~5-6 hours of focused work.**

---
*FLOW cycle complete. All four phases documented. Ready for implementation.*
